name: CI

on: [push, pull_request]

jobs:
  rspec:
    strategy:
      fail-fast: false
      matrix:
        ruby: [2.5, 2.6, 2.7, '3.0', 3.1, 3.2, 3.3, 3.4, ruby-head, jruby-9.2, jruby-9.3, jruby-9.4, jruby-head]
        platform: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          # macos-latest can't run ruby-2.5. or jruby-9.2
          - { platform: macos-latest, ruby: 2.5 }
          - { platform: macos-latest, ruby: jruby-9.2 }
          # ubuntu-latest can't run jruby-9.2
          - { platform: ubuntu-latest, ruby: jruby-9.2 }
          # ubuntu-latest/ruby-3.4 is covered by the coverage test
          - { platform: ubuntu-latest, ruby: 3.4 }
        include:
          - { platform: macos-13, ruby: 2.5 }
          - { platform: macos-13, ruby: jruby-9.2 }
          - { platform: ubuntu-22.04, ruby: jruby-9.2 }
    continue-on-error: ${{ endsWith(matrix.ruby, 'head') }}
    runs-on: ${{matrix.platform}}
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
    - run: bundle exec rspec spec --tag=~real_git
      timeout-minutes: 10

  compare:
    strategy:
      fail-fast: false
      matrix:
        repo:
          - rails/rails
          - ruby/ruby
          - facebook/react
        platform: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{matrix.platform}}
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true
    - run: git clone --depth 1 https://github.com/${{ matrix.repo }}.git target
      timeout-minutes: 5
    - if: matrix.platform == 'windows-latest'
      run: |
        Set-Location target
        ruby ..\bin\compare
        ruby ..\bin\time
      # id: compare
      timeout-minutes: 1
    - if: matrix.platform != 'windows-latest'
      run: |
        cd target
        ../bin/compare
        ../bin/time
      id: compare
      timeout-minutes: 2
    - run: cd target && ../bin/parse
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && ../bin/ls
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git ls-files
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && ../bin/ls '*.gitignore' | xargs tail -n +1
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && find *
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git ls-files -ic --exclude-standard
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git diff --no-renames --diff-filter=D --name-only
      if: failure() && steps.compare.outcome == 'failure'
    - run: cd target && git ls-files --others --exclude-standard
      if: failure() && steps.compare.outcome == 'failure'

  real_git:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4
          bundler-cache: true
      - run: TRACE=1 bundle exec rspec --tag=real_git
        timeout-minutes: 5

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4
          bundler-cache: true
      - run: COVERAGE=1 bundle exec rspec --tag=~real_git
        timeout-minutes: 5
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: 'coverage/*'
          retention-days: 1
        if: ${{ failure() }}
        timeout-minutes: 5

  rubocop:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true
    - run: bundle exec rubocop
      timeout-minutes: 5

  spellr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true
    - run: bundle exec spellr
      timeout-minutes: 1

  leftovers:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true
    - run: bundle exec leftovers
      timeout-minutes: 1

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.4
        bundler-cache: true
    - run: bundle exec rake build
      timeout-minutes: 1
